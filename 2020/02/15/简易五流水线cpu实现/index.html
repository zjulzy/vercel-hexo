<!DOCTYPE html><html lang="zh-cn" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>简易五流水线cpu实现 | Hexo</title><meta name="author" content="lenmain"><meta name="copyright" content="lenmain"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="流水线 cpu 的简易实现github项目地址">
<meta property="og:type" content="article">
<meta property="og:title" content="简易五流水线cpu实现">
<meta property="og:url" content="https://vercel-hexo-ten.vercel.app/2020/02/15/%E7%AE%80%E6%98%93%E4%BA%94%E6%B5%81%E6%B0%B4%E7%BA%BFcpu%E5%AE%9E%E7%8E%B0/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="流水线 cpu 的简易实现github项目地址">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg">
<meta property="article:published_time" content="2020-02-14T23:57:08.000Z">
<meta property="article:modified_time" content="2020-09-25T02:18:24.980Z">
<meta property="article:author" content="lenmain">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://vercel-hexo-ten.vercel.app/2020/02/15/%E7%AE%80%E6%98%93%E4%BA%94%E6%B5%81%E6%B0%B4%E7%BA%BFcpu%E5%AE%9E%E7%8E%B0/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  hexoversion: '5.2.0',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true,
  postUpdate: '2020-09-25 10:18:24'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {
  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }

  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }
})()</script><meta name="generator" content="Hexo 5.2.0"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/null" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">Articles</div><div class="length_num">8</div></a></div></div></div><hr/></div></div><div id="body-wrap"><div id="sidebar"><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%81%E6%B0%B4%E7%BA%BF-cpu-%E7%9A%84%E7%AE%80%E6%98%93%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.</span> <span class="toc-text">流水线 cpu 的简易实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E6%95%B4%E4%BD%93%E6%80%9D%E8%B7%AF"><span class="toc-number">1.1.</span> <span class="toc-text">一、整体思路</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E6%B5%81%E6%B0%B4%E7%BA%BF-cpu"><span class="toc-number">1.1.1.</span> <span class="toc-text">1. 流水线 cpu</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-mips-%E6%8C%87%E4%BB%A4%E9%9B%86"><span class="toc-number">1.1.2.</span> <span class="toc-text">2.mips 指令集</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%86%B2%E7%AA%81%E7%AE%A1%E7%90%86"><span class="toc-number">1.1.3.</span> <span class="toc-text">3. 冲突管理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E7%BB%84%E6%88%90%E6%A8%A1%E5%9D%97"><span class="toc-number">1.2.</span> <span class="toc-text">二、组成模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%AD%98%E5%82%A8%E5%99%A8"><span class="toc-number">1.2.1.</span> <span class="toc-text">1. 存储器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E7%BA%A7%E9%97%B4%E5%AF%84%E5%AD%98%E5%99%A8"><span class="toc-number">1.2.2.</span> <span class="toc-text">2. 级间寄存器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E6%8E%A7%E5%88%B6%E6%A8%A1%E5%9D%97"><span class="toc-number">1.2.3.</span> <span class="toc-text">3. 控制模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E8%BF%90%E7%AE%97%E5%99%A8%E5%8F%8A%E8%BF%90%E7%AE%97%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="toc-number">1.2.4.</span> <span class="toc-text">4. 运算器及运算控制器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E7%A8%8B%E5%BA%8F%E8%AE%A1%E6%95%B0%E5%99%A8"><span class="toc-number">1.2.5.</span> <span class="toc-text">5. 程序计数器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-%E5%86%B2%E7%AA%81%E6%A3%80%E6%B5%8B%E6%A8%A1%E5%9D%97"><span class="toc-number">1.2.6.</span> <span class="toc-text">6. 冲突检测模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-%E5%AF%84%E5%AD%98%E5%99%A8%E7%BB%84%E6%A8%A1%E5%9D%97"><span class="toc-number">1.2.7.</span> <span class="toc-text">7. 寄存器组模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-%E5%85%B6%E4%BB%96%E9%80%BB%E8%BE%91%E6%A8%A1%E5%9D%97"><span class="toc-number">1.2.8.</span> <span class="toc-text">8. 其他逻辑模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#9-cpu-%E9%A1%B6%E5%B1%82%E6%A8%A1%E5%9D%97"><span class="toc-number">1.2.9.</span> <span class="toc-text">9.cpu 顶层模块</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E6%B5%8B%E8%AF%95%E6%96%B9%E6%B3%95%E5%92%8C%E5%B7%A5%E5%85%B7"><span class="toc-number">1.3.</span> <span class="toc-text">三、测试方法和工具</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E6%B1%87%E7%BC%96%E5%99%A8"><span class="toc-number">1.3.1.</span> <span class="toc-text">1. 汇编器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%AD%98%E5%82%A8%E5%99%A8%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">1.3.2.</span> <span class="toc-text">2. 存储器初始化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E6%B5%8B%E8%AF%95%E7%BB%93%E6%9E%9C"><span class="toc-number">1.4.</span> <span class="toc-text">四、测试结果</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E6%B5%8B%E8%AF%95%E6%8C%87%E4%BB%A4"><span class="toc-number">1.4.1.</span> <span class="toc-text">1. 测试指令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-vivado-%E6%A8%A1%E6%8B%9F"><span class="toc-number">1.4.2.</span> <span class="toc-text">2.vivado 模拟</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E6%B5%8B%E8%AF%95%E6%A8%A1%E5%9D%97"><span class="toc-number">1.4.3.</span> <span class="toc-text">3. 测试模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E6%B3%A2%E5%BD%A2%E6%95%88%E6%9E%9C"><span class="toc-number">1.4.4.</span> <span class="toc-text">4. 波形效果</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E6%94%B9%E8%BF%9B%E6%96%B9%E6%A1%88"><span class="toc-number">1.5.</span> <span class="toc-text">五、改进方案</span></a></li></ol></li></ol></div></div></div><header class="post-bg" id="page-header" style="background-image: url(https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Hexo</a></span><span id="menus"><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">简易五流水线cpu实现</div></div><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2020-02-14T23:57:08.000Z" title="Created 2020-02-15 07:57:08">2020-02-15</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2020-09-25T02:18:24.980Z" title="Updated 2020-09-25 10:18:24">2020-09-25</time></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h2 id="流水线-cpu-的简易实现"><a href="#流水线-cpu-的简易实现" class="headerlink" title="流水线 cpu 的简易实现"></a>流水线 cpu 的简易实现</h2><p><a target="_blank" rel="noopener" href="https://github.com/xjlizeyu/pipelined-CPU">github项目地址</a></p>
<a id="more"></a>
<h3 id="一、整体思路"><a href="#一、整体思路" class="headerlink" title="一、整体思路"></a>一、整体思路</h3><h4 id="1-流水线-cpu"><a href="#1-流水线-cpu" class="headerlink" title="1. 流水线 cpu"></a>1. 流水线 cpu</h4><img src="https://blogpics.lenmain.cn/static/images/2019-12-27-15-20-01.png">

<p>流水线 cpu 中一个指令执行的五个周期如上图所示。<br>为了解决流水线同步问题，设计 cpu 中级间寄存器由上升沿触发，周期内器件由下降沿触发。</p>
<img src="https://blogpics.lenmain.cn/static/images/2019-12-25-15-10-11.png">

<p>上图为书上的流水线 cpu 基本数据通路，本次实验主要在此基础上进行改进，且添加冲突处理模块，在实验过程中，我也发现了该图中很多不足的地方。</p>
<h4 id="2-mips-指令集"><a href="#2-mips-指令集" class="headerlink" title="2.mips 指令集"></a>2.mips 指令集</h4><img src="https://blogpics.lenmain.cn/static/images/2019-12-28-13-52-25.png">
<p>mips 指令分为 R 型，I 型和 J 型，其中 R 型有三个操作数，I 型携带立即数，J 型为跳转指令。<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41848006/article/details/82256626">MIPS 指令</a></p>
<h4 id="3-冲突管理"><a href="#3-冲突管理" class="headerlink" title="3. 冲突管理"></a>3. 冲突管理</h4><p>冲突管理是流水线 cpu 不得不面对的一个问题，解决方法主要为插入气泡来阻塞指令运行，已经增加新的数据回路使前指令的结果尽快回送到寄存器中。本次实验主要采取的是气泡插入法，结构较为简单但是降低了效率。</p>
<p>cpu 的冲突主要分为三种，结构冲突，数据冲突和控制冲突。结构冲突通过流水线 cpu 的结构设计可以避免，数据冲突主要是相距较近的指令所需数据地址相同产生的时间冲突，控制冲突主要针对跳转指令，本次实验中的冲突检测模块维护了一个队列用来检测冲突，从而解决数据冲突，对于控制冲突，由于数据通路问题无法较早回送，只能插入气泡。</p>
<h3 id="二、组成模块"><a href="#二、组成模块" class="headerlink" title="二、组成模块"></a>二、组成模块</h3><h4 id="1-存储器"><a href="#1-存储器" class="headerlink" title="1. 存储器"></a>1. 存储器</h4><blockquote>
<p>存储器分为指令存储器（IM）和数据存储器（DM）两部分。<br>指令存储器通过 PC 的输出<br><strong>verilog 代码实现</strong></p>
</blockquote>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs verilog"><span class="hljs-keyword">module</span> DataMemory(<br>    <span class="hljs-keyword">input</span> Mem_rd,Mem_wr,<br>    <span class="hljs-keyword">input</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>] Addr,wr_data,<br>    <span class="hljs-keyword">output</span> <span class="hljs-keyword">reg</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]rd_data<br>);<br>    <span class="hljs-keyword">reg</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]data[<span class="hljs-number">31</span>:<span class="hljs-number">0</span>];<br>    <span class="hljs-keyword">integer</span> i;<br>    <span class="hljs-keyword">initial</span> <span class="hljs-keyword">begin</span><span class="hljs-comment">//给存储器赋初值</span><br>    rd_data = <span class="hljs-number">32&#x27;bz</span>;<br>        <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>;i&lt; <span class="hljs-number">32</span>;i++)<span class="hljs-keyword">begin</span><br>            data[i] = i;<br>        <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">always</span>@(*)<span class="hljs-keyword">begin</span><br>        <span class="hljs-keyword">if</span>(Mem_rd)<span class="hljs-keyword">begin</span><br>            rd_data = data[Addr];<br>        <span class="hljs-keyword">end</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(Mem_wr)<span class="hljs-keyword">begin</span><br>            data[Addr] = wr_data;<br>        <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">endmodule</span><br><br><span class="hljs-keyword">module</span> InstructionMemory(<br>    <span class="hljs-keyword">input</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]Addr,<br>    <span class="hljs-keyword">output</span> <span class="hljs-keyword">reg</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]Instr<br>);<br>    <span class="hljs-keyword">reg</span>[<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] instr[<span class="hljs-number">127</span>:<span class="hljs-number">0</span>];<br>    <span class="hljs-keyword">initial</span> <span class="hljs-keyword">begin</span><br>        <span class="hljs-built_in">$readmemh</span>(<span class="hljs-string">&quot;txt/instruction.txt&quot;</span>, instr);<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">always</span> @(*) <span class="hljs-keyword">begin</span><br>        Instr = &#123;instr[Addr],instr[Addr+<span class="hljs-number">1</span>],instr[Addr+<span class="hljs-number">2</span>],instr[Addr+<span class="hljs-number">3</span>]&#125;;<span class="hljs-comment">//指令存储器按字节编址</span><br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">endmodule</span><br></code></pre></td></tr></table></figure>

<h4 id="2-级间寄存器"><a href="#2-级间寄存器" class="headerlink" title="2. 级间寄存器"></a>2. 级间寄存器</h4><blockquote>
<p>级间寄存器是流水线 cpu 最为关键的部分，承担着在各不同周期之间传递指令和标志位的作用。<br>级间寄存器由同步信号驱动，控制各自周期内部计算的开始并分割指令的各周期。<br>在冲突发生时，FI/ID 级间寄存器阻塞并将所有标志位置零，防止指令向下运行。<br><strong>verilog 代码实现</strong></p>
</blockquote>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><code class="hljs verilog"><br><span class="hljs-comment">//FI,ID级间寄存器</span><br><span class="hljs-comment">// 各级间寄存器将指令在下一周期使用的信号位伴随指令传入下一周期</span><br><span class="hljs-comment">// 从而减轻控制器负担</span><br><span class="hljs-comment">// 控制器只需在每次取指令后计算出与该指令相关的所有周期的信号位即可</span><br><span class="hljs-keyword">module</span> RegFI_ID(<br>        <span class="hljs-keyword">input</span> clk,<br>        <span class="hljs-keyword">input</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]NPC1in,<br>        <span class="hljs-keyword">input</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]IRin,<br>        <span class="hljs-keyword">input</span> suspend,<br>        <span class="hljs-keyword">input</span> reg_wr_in,ALU_src_in,Jump_in,Branch_in,Mem_rd_in,Mem_wr_in,MemtoReg_in,RegDst_in,<br>        <span class="hljs-keyword">output</span> <span class="hljs-keyword">reg</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]NPC1out,<br>        <span class="hljs-keyword">output</span> <span class="hljs-keyword">reg</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]IRout,<br>        <span class="hljs-keyword">output</span> <span class="hljs-keyword">reg</span> reg_wr,ALU_src,Jump,Branch,Mem_rd,Mem_wr,MemtoReg,RegDst<br>    );<br>    <span class="hljs-keyword">always</span>@(<span class="hljs-keyword">posedge</span> clk) <span class="hljs-keyword">begin</span><br>        <span class="hljs-keyword">if</span>(!suspend)<span class="hljs-keyword">begin</span><br>            NPC1out &lt;= NPC1in;<br>            IRout &lt;= IRin;<br>            ALU_src &lt;= ALU_src_in;<br>            Jump &lt;= Jump_in;<br>            Branch &lt;= Branch_in;<br>            Mem_rd &lt;= Mem_rd_in;<br>            Mem_wr &lt;= Mem_wr_in;<br>            reg_wr &lt;= reg_wr_in;<br>            MemtoReg &lt;= MemtoReg_in;<br>            RegDst &lt;= RegDst_in;<br>        <span class="hljs-keyword">end</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">begin</span><br>            ALU_src &lt;= <span class="hljs-number">1&#x27;b0</span>;<br>            Jump &lt;= <span class="hljs-number">1&#x27;b0</span>;<br>            Branch &lt;= <span class="hljs-number">1&#x27;b0</span>;<br>            Mem_rd &lt;= <span class="hljs-number">1&#x27;b0</span>;<br>            Mem_wr &lt;= <span class="hljs-number">1&#x27;b0</span>;<br>            reg_wr &lt;= <span class="hljs-number">1&#x27;b0</span>;<br>            MemtoReg &lt;= <span class="hljs-number">1&#x27;b0</span>;<br>            RegDst &lt;= <span class="hljs-number">1&#x27;b0</span>;<br>        <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">endmodule</span><br><br><span class="hljs-comment">//ID,EX级间寄存器</span><br><span class="hljs-keyword">module</span> RegID_EX(<br>    <span class="hljs-keyword">input</span> clk,<br>    <span class="hljs-keyword">input</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]NPC1in,<br>    <span class="hljs-keyword">input</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]Rsin,Rtin,<br>    <span class="hljs-keyword">input</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]Instruction32,<br>    <span class="hljs-keyword">input</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]IRin,<br>    <span class="hljs-keyword">input</span> reg_wr_in,ALU_src_in,Jump_in,Branch_in,Mem_rd_in,Mem_wr_in,MemtoReg_in,RegDst_in,<br>    <span class="hljs-keyword">output</span> <span class="hljs-keyword">reg</span>[<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]NPC1out,<br>    <span class="hljs-keyword">output</span> <span class="hljs-keyword">reg</span>[<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]IRout,<br>    <span class="hljs-keyword">output</span> <span class="hljs-keyword">reg</span>[<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]Rt,Rs,<br>    <span class="hljs-keyword">output</span> <span class="hljs-keyword">reg</span>[<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]Imm32,<br>    <span class="hljs-keyword">output</span> <span class="hljs-keyword">reg</span> reg_wr,ALU_src,Jump,Branch,Mem_rd,Mem_wr,MemtoReg,RegDst<br>    );<br>    <span class="hljs-keyword">always</span> @(<span class="hljs-keyword">posedge</span> clk) <span class="hljs-keyword">begin</span><br>        Rs &lt;= Rsin;<br>        Rt &lt;= Rtin;<br>        Imm32 &lt;= Instruction32;<br>        NPC1out &lt;= NPC1in;<br>        IRout &lt;= IRin;<br>        ALU_src &lt;= ALU_src_in;<br>        Jump &lt;= Jump_in;<br>        Branch &lt;= Branch_in;<br>        Mem_rd &lt;= Mem_rd_in;<br>        Mem_wr &lt;= Mem_wr_in;<br>        reg_wr &lt;= reg_wr_in;<br>        MemtoReg &lt;= MemtoReg_in;<br>        RegDst &lt;= RegDst_in;<br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">endmodule</span><br><br><span class="hljs-comment">//EX,MA级间寄存器</span><br><span class="hljs-keyword">module</span> RegMA_WB(<br>    <span class="hljs-keyword">input</span> clk,<br>    <span class="hljs-keyword">input</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]ALU,MEM,IRin,<br>    <span class="hljs-keyword">input</span> MemtoReg_in,RegDst_in,reg_wr_in,<br>    <span class="hljs-keyword">output</span> <span class="hljs-keyword">reg</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]ALUout,<br>    <span class="hljs-keyword">output</span> <span class="hljs-keyword">reg</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]MEMout,<br>    <span class="hljs-keyword">output</span> <span class="hljs-keyword">reg</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]IRout,<br>    <span class="hljs-keyword">output</span> <span class="hljs-keyword">reg</span> MemtoReg,RegDst,reg_wr<br>);<br>    <span class="hljs-keyword">always</span> @(<span class="hljs-keyword">posedge</span> clk) <span class="hljs-keyword">begin</span><br>        ALUout &lt;= ALU;<br>        MEMout &lt;= MEM;<br>        IRout &lt;= IRin;<br>        reg_wr &lt;= reg_wr_in;<br>        MemtoReg &lt;= MemtoReg_in;<br>        RegDst &lt;= RegDst_in;<br><br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">endmodule</span><br><br><span class="hljs-comment">//MA,WB级间寄存器</span><br><span class="hljs-keyword">module</span> RegEX_MA(<br>    <span class="hljs-keyword">input</span> clk,<br>    <span class="hljs-keyword">input</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]NPC3_in,NPC2_in,<br>    <span class="hljs-keyword">input</span> flag_in,reg_wr_in,Jump_in,Branch_in,Mem_rd_in,Mem_wr_in,MemtoReg_in,RegDst_in,<br>    <span class="hljs-keyword">input</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]ALUout_in,Rt_in,IR_in,<br>    <span class="hljs-keyword">output</span> <span class="hljs-keyword">reg</span> flag,reg_wr,Jump,Branch,Mem_rd,Mem_wr,MemtoReg,RegDst,<br>    <span class="hljs-keyword">output</span> <span class="hljs-keyword">reg</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]NPC3,NPC2,<br>    <span class="hljs-keyword">output</span> <span class="hljs-keyword">reg</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]ALUout,Rt,IR<br>);<br>    <span class="hljs-keyword">always</span> @(<span class="hljs-keyword">posedge</span> clk) <span class="hljs-keyword">begin</span><br>        NPC3 &lt;= NPC3_in;<br>        NPC2 &lt;= NPC2_in;<br>        ALUout &lt;= ALUout_in;<br>        Rt &lt;= Rt_in;<br>        IR &lt;= IR_in;<br>        Jump &lt;= Jump_in;<br>        Branch &lt;= Branch_in;<br>        Mem_rd &lt;= Mem_rd_in;<br>        Mem_wr &lt;= Mem_wr_in;<br>        reg_wr &lt;= reg_wr_in;<br>        MemtoReg &lt;= MemtoReg_in;<br>        RegDst &lt;= RegDst_in;<br>        flag&lt;=flag_in;<br>    <span class="hljs-keyword">end</span><br><br><span class="hljs-keyword">endmodule</span><br></code></pre></td></tr></table></figure>

<h4 id="3-控制模块"><a href="#3-控制模块" class="headerlink" title="3. 控制模块"></a>3. 控制模块</h4><blockquote>
<p>控制模块通过识别指令输出对应的个标志位的值给级间寄存器。<br>由于流水线 cpu 的标志位较少，且可以借助级间寄存器传递相应指令的标志位，<br>可以直接使用组合逻辑电路实现。<br><strong>verilog 代码实现</strong></p>
</blockquote>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs verilog"><span class="hljs-meta">`<span class="hljs-meta-keyword">define</span> LW 6&#x27;b100011</span><br><span class="hljs-meta">`<span class="hljs-meta-keyword">define</span> SW 6&#x27;b101011</span><br><span class="hljs-meta">`<span class="hljs-meta-keyword">define</span> ADD 6&#x27;b100000</span><br><span class="hljs-meta">`<span class="hljs-meta-keyword">define</span> SUB 6&#x27;b100010</span><br><span class="hljs-meta">`<span class="hljs-meta-keyword">define</span> ADDU 6&#x27;b100001</span><br><span class="hljs-meta">`<span class="hljs-meta-keyword">define</span> AND 6&#x27;b100100</span><br><span class="hljs-meta">`<span class="hljs-meta-keyword">define</span> OR 6&#x27;b100101</span><br><span class="hljs-meta">`<span class="hljs-meta-keyword">define</span> SLT 6&#x27;b101010</span><br><span class="hljs-meta">`<span class="hljs-meta-keyword">define</span> BEQ 6&#x27;b000100</span><br><span class="hljs-meta">`<span class="hljs-meta-keyword">define</span> J 6&#x27;b000010</span><br><span class="hljs-meta">`<span class="hljs-meta-keyword">define</span> R 6&#x27;b000000</span><br><span class="hljs-meta">`<span class="hljs-meta-keyword">define</span> HALT 6&#x27;b111111</span><br><span class="hljs-keyword">module</span> ControlUnit(<br>    <span class="hljs-keyword">input</span> [<span class="hljs-number">5</span>:<span class="hljs-number">0</span>] OP_code,<br>    <span class="hljs-keyword">output</span>  Reg_wr,<br>    <span class="hljs-keyword">output</span> ALU_src,<br>    <span class="hljs-keyword">output</span> Jump,<br>    <span class="hljs-keyword">output</span> Branch,<br>    <span class="hljs-keyword">output</span> MemtoReg,<br>    <span class="hljs-keyword">output</span> RegDst,<br>    <span class="hljs-keyword">output</span> Mem_rd,<br>    <span class="hljs-keyword">output</span> Mem_wr<br>);<br><br>    <span class="hljs-keyword">assign</span> Reg_wr=(OP_code== <span class="hljs-meta">`R||OP_code==` LW)?1:0;</span><br>    <span class="hljs-keyword">assign</span> Jump=(OP_code==<span class="hljs-meta">`J)?1:0;</span><br>    <span class="hljs-keyword">assign</span> RegDst=(OP_code==<span class="hljs-meta">`R)?1:0;</span><br>    <span class="hljs-keyword">assign</span> Branch=(OP_code==<span class="hljs-meta">`BEQ)?1:0;</span><br>    <span class="hljs-keyword">assign</span> MemtoReg=(OP_code==<span class="hljs-meta">`LW)?1:0;</span><br>    <span class="hljs-keyword">assign</span> Mem_rd=(OP_code==<span class="hljs-meta">`LW)?1:0;</span><br>    <span class="hljs-keyword">assign</span> Mem_wr=(OP_code==<span class="hljs-meta">`SW)?1:0;</span><br>    <span class="hljs-keyword">assign</span> ALU_src=(OP_code== <span class="hljs-meta">`LW||OP_code==` SW)?1:0;</span><br><span class="hljs-keyword">endmodule</span><br><br></code></pre></td></tr></table></figure>

<h4 id="4-运算器及运算控制器"><a href="#4-运算器及运算控制器" class="headerlink" title="4. 运算器及运算控制器"></a>4. 运算器及运算控制器</h4><blockquote>
<p>运算器（ALU）即指令执行的主要模块，工作在 EX 周期。<br>在流水线 cpu 中，通过添加加法器，分离部分运算器功能的方法可以解决部分冲突问题<br><strong>verilog 代码实现</strong></p>
</blockquote>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs verilog"><span class="hljs-keyword">module</span> ALU(<br>    <span class="hljs-keyword">input</span> [<span class="hljs-number">2</span>:<span class="hljs-number">0</span>]alu_op,<br>    <span class="hljs-keyword">input</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]A,B,<br>    <span class="hljs-keyword">output</span> flag,<br>    <span class="hljs-keyword">output</span> <span class="hljs-keyword">reg</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]ALU_out<br>);<br>    <span class="hljs-keyword">always</span> @(*) <span class="hljs-keyword">begin</span><br>        <span class="hljs-keyword">case</span>(alu_op)<br>            <span class="hljs-number">3&#x27;b000</span>:ALU_out=A+B;<br>            <span class="hljs-number">3&#x27;b001</span>:ALU_out=A-B;<br>            <span class="hljs-number">3&#x27;b010</span>:ALU_out=A*B;<br>            <span class="hljs-number">3&#x27;b011</span>:ALU_out=A&lt;B?<span class="hljs-number">1</span>:<span class="hljs-number">0</span>;<br>            <span class="hljs-number">3&#x27;b100</span>:ALU_out=A&amp;B;<br>            <span class="hljs-number">3&#x27;b101</span>:ALU_out=A|B;<br>            <span class="hljs-number">3&#x27;b110</span>:ALU_out=~A;<br>            <span class="hljs-number">3&#x27;b111</span>:ALU_out=A^B;<br>            <span class="hljs-keyword">default</span>:ALU_out=<span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">endcase</span><br><br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">assign</span> flag=(ALU_out==<span class="hljs-number">0</span>)?<span class="hljs-number">1&#x27;b1</span>:<span class="hljs-number">1&#x27;b0</span>;<br><span class="hljs-keyword">endmodule</span><br><span class="hljs-meta">`<span class="hljs-meta-keyword">define</span> LW 6&#x27;b100011</span><br><span class="hljs-meta">`<span class="hljs-meta-keyword">define</span> SW 6&#x27;b101011</span><br><span class="hljs-meta">`<span class="hljs-meta-keyword">define</span> ADD 6&#x27;b100000</span><br><span class="hljs-meta">`<span class="hljs-meta-keyword">define</span> SUB 6&#x27;b100010</span><br><span class="hljs-meta">`<span class="hljs-meta-keyword">define</span> ADDU 6&#x27;b100001</span><br><span class="hljs-meta">`<span class="hljs-meta-keyword">define</span> AND 6&#x27;b100100</span><br><span class="hljs-meta">`<span class="hljs-meta-keyword">define</span> OR 6&#x27;b100101</span><br><span class="hljs-meta">`<span class="hljs-meta-keyword">define</span> SLT 6&#x27;b101010</span><br><span class="hljs-meta">`<span class="hljs-meta-keyword">define</span> BEQ 6&#x27;b000100</span><br><span class="hljs-meta">`<span class="hljs-meta-keyword">define</span> J 6&#x27;b000010</span><br><span class="hljs-meta">`<span class="hljs-meta-keyword">define</span> R 6&#x27;b000000</span><br><span class="hljs-meta">`<span class="hljs-meta-keyword">define</span> HALT 6&#x27;b111111</span><br><br><span class="hljs-keyword">module</span> AluControl(<br>    <span class="hljs-keyword">input</span> [<span class="hljs-number">5</span>:<span class="hljs-number">0</span>]OP_code,<span class="hljs-comment">//func</span><br>    <span class="hljs-keyword">input</span> [<span class="hljs-number">5</span>:<span class="hljs-number">0</span>]ALU_op,<span class="hljs-comment">//识别码R型指令为6位0</span><br>    <span class="hljs-keyword">output</span> <span class="hljs-keyword">reg</span> [<span class="hljs-number">2</span>:<span class="hljs-number">0</span>]ALUctrl<br>);<br>    <span class="hljs-keyword">always</span> @(*) <span class="hljs-keyword">begin</span><br>        <span class="hljs-keyword">if</span>(ALU_op==<span class="hljs-number">6&#x27;b0</span>)<span class="hljs-keyword">begin</span><br>            <span class="hljs-keyword">case</span>(OP_code)<br>                <span class="hljs-meta">`ADD:ALUctrl&lt;=3&#x27;b000;</span><br>                <span class="hljs-meta">`SUB:ALUctrl&lt;=3&#x27;b001;</span><br>                <span class="hljs-meta">`ADDU:ALUctrl&lt;=3&#x27;b000;</span><br>                <span class="hljs-meta">`AND:ALUctrl&lt;=3&#x27;b100;</span><br>                <span class="hljs-meta">`OR:ALUctrl&lt;=3&#x27;b101;</span><br>                <span class="hljs-meta">`SLT:ALUctrl&lt;=3&#x27;b011;</span><br>                <span class="hljs-keyword">default</span>:ALUctrl&lt;=<span class="hljs-number">3&#x27;b111</span>;<br>            <span class="hljs-keyword">endcase</span><br>        <span class="hljs-keyword">end</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">begin</span><br>            <span class="hljs-keyword">if</span>(ALU_op==<span class="hljs-meta">`BEQ)begin</span><br>                ALUctrl &lt;= <span class="hljs-number">3&#x27;b001</span>;<br>            <span class="hljs-keyword">end</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(ALU_op== <span class="hljs-meta">`LW||ALU_op==` SW)begin</span><br>                ALUctrl&lt;=<span class="hljs-number">3&#x27;b000</span>;<br>            <span class="hljs-keyword">end</span><br>        <span class="hljs-keyword">end</span><br><br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">endmodule</span><br></code></pre></td></tr></table></figure>

<h4 id="5-程序计数器"><a href="#5-程序计数器" class="headerlink" title="5. 程序计数器"></a>5. 程序计数器</h4><blockquote>
<p>程序计数器（PC）记录下一步指令的地址，主要在 FI 周期工作。<br>PC 通过加法器实现自增功能，但在冲突发生时，关闭自增。<br><strong>verilog 代码实现</strong></p>
</blockquote>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs verilog"><span class="hljs-comment">//PC</span><br><span class="hljs-keyword">module</span> ProgramCounter(<br>    <span class="hljs-keyword">input</span> clk,<br>    <span class="hljs-keyword">input</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]addrin,<br>    <span class="hljs-keyword">input</span> insist,<br>    <span class="hljs-keyword">output</span> <span class="hljs-keyword">reg</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]addrout<br>    );<br>    <span class="hljs-keyword">initial</span> <span class="hljs-keyword">begin</span><br>        addrout = <span class="hljs-number">32&#x27;b0</span>;<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">always</span> @(<span class="hljs-keyword">posedge</span> clk) <span class="hljs-keyword">begin</span><br>        <span class="hljs-keyword">if</span>(!insist)<br>            addrout = addrin;<br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">endmodule</span><br></code></pre></td></tr></table></figure>

<h4 id="6-冲突检测模块"><a href="#6-冲突检测模块" class="headerlink" title="6. 冲突检测模块"></a>6. 冲突检测模块</h4><blockquote>
<p>流水线 cpu 主要需要解决数据冒险和控制冒险的问题，主要工作于 FI 周期。<br>本次实验采用后推产生气泡的方法解决冒险，在冲突检测模块中建立队列存储已经执行指令影响的寄存器；<br>取出新指令时，在队列中对比，如发现冲突，则产生气泡，后退冲突影响指令。<br>产生气泡时阻塞 PC 自增并使 FI/ID 级间寄存器中各数据位归零，使得指令无法运行。<br>由于级间寄存器上升沿触发，冲突检测模块应由下降沿触发。<br><strong>verilog 代码实现</strong></p>
</blockquote>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><code class="hljs verilog"><span class="hljs-meta">`<span class="hljs-meta-keyword">define</span> LW 6&#x27;b100011</span><br><span class="hljs-meta">`<span class="hljs-meta-keyword">define</span> SW 6&#x27;b101011</span><br><span class="hljs-meta">`<span class="hljs-meta-keyword">define</span> ADD 6&#x27;b100000</span><br><span class="hljs-meta">`<span class="hljs-meta-keyword">define</span> SUB 6&#x27;b100010</span><br><span class="hljs-meta">`<span class="hljs-meta-keyword">define</span> ADDU 6&#x27;b100001</span><br><span class="hljs-meta">`<span class="hljs-meta-keyword">define</span> AND 6&#x27;b100100</span><br><span class="hljs-meta">`<span class="hljs-meta-keyword">define</span> OR 6&#x27;b100101</span><br><span class="hljs-meta">`<span class="hljs-meta-keyword">define</span> SLT 6&#x27;b101010</span><br><span class="hljs-meta">`<span class="hljs-meta-keyword">define</span> BEQ 6&#x27;b000100</span><br><span class="hljs-meta">`<span class="hljs-meta-keyword">define</span> J 6&#x27;b000010</span><br><span class="hljs-meta">`<span class="hljs-meta-keyword">define</span> R 6&#x27;b000000</span><br><span class="hljs-meta">`<span class="hljs-meta-keyword">define</span> HALT 6&#x27;b111111</span><br><br><span class="hljs-keyword">module</span> HazardDetection(<br>    <span class="hljs-keyword">input</span> clk,<br>    <span class="hljs-keyword">input</span> [<span class="hljs-number">5</span>:<span class="hljs-number">0</span>]OP_code,<br>    <span class="hljs-keyword">input</span> [<span class="hljs-number">4</span>:<span class="hljs-number">0</span>]rd,<br>    <span class="hljs-keyword">input</span> [<span class="hljs-number">4</span>:<span class="hljs-number">0</span>]rs,rt,<br>    <span class="hljs-keyword">output</span> <span class="hljs-keyword">reg</span> [<span class="hljs-number">1</span>:<span class="hljs-number">0</span>]suspend<br>);<br>    <span class="hljs-keyword">reg</span>[<span class="hljs-number">2</span>:<span class="hljs-number">0</span>]quene[<span class="hljs-number">4</span>:<span class="hljs-number">0</span>];<br>    <span class="hljs-keyword">integer</span> i;<br>    <span class="hljs-keyword">reg</span> flag;<br>    <span class="hljs-keyword">initial</span> <span class="hljs-keyword">begin</span><br>        <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>;i&lt;<span class="hljs-number">3</span>;i++)<span class="hljs-keyword">begin</span><br>            quene[i]=<span class="hljs-number">5&#x27;bz</span>;<br>            suspend = <span class="hljs-number">2&#x27;b0</span>;<br>        <span class="hljs-keyword">end</span><br>        flag = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">always</span> @(<span class="hljs-keyword">negedge</span> clk) <span class="hljs-keyword">begin</span><br>        <span class="hljs-keyword">if</span>(OP_code==<span class="hljs-meta">`R)begin</span><br>            <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>;i&lt;<span class="hljs-number">3</span>;i++)<span class="hljs-keyword">begin</span><br>                <span class="hljs-keyword">if</span>(rs==quene[i]||rt==quene[i])<span class="hljs-keyword">begin</span><br>                    suspend=<span class="hljs-number">2&#x27;b11</span>;<br>                    <span class="hljs-keyword">repeat</span>(<span class="hljs-number">3</span>-i)<span class="hljs-keyword">begin</span><br>                        #<span class="hljs-number">20</span>;<br>                    <span class="hljs-keyword">end</span><br>                    suspend = <span class="hljs-number">2&#x27;b0</span>;<br>                    flag = <span class="hljs-number">1</span>;<br>                <span class="hljs-keyword">end</span><br>            <span class="hljs-keyword">end</span><br>            <span class="hljs-keyword">if</span>(!flag)<span class="hljs-keyword">begin</span><br>                quene[<span class="hljs-number">2</span>] = quene[<span class="hljs-number">1</span>];<br>                quene[<span class="hljs-number">1</span>] = quene[<span class="hljs-number">0</span>];<br>                quene[<span class="hljs-number">0</span>] = rd;<br>            <span class="hljs-keyword">end</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">begin</span><br>                quene[<span class="hljs-number">0</span>] = rd;<br>                quene[<span class="hljs-number">1</span>] = <span class="hljs-number">5&#x27;bz</span>;<br>                quene[<span class="hljs-number">2</span>] = <span class="hljs-number">5&#x27;bz</span>;<br>                flag = <span class="hljs-number">0</span>;<br>            <span class="hljs-keyword">end</span><br>        <span class="hljs-keyword">end</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(OP_code==<span class="hljs-meta">`LW)begin</span><br>            quene[<span class="hljs-number">2</span>] = quene[<span class="hljs-number">1</span>];<br>            quene[<span class="hljs-number">1</span>] = quene[<span class="hljs-number">0</span>];<br>            quene[<span class="hljs-number">0</span>] = rt;<br>        <span class="hljs-keyword">end</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(OP_code==<span class="hljs-meta">`SW)begin</span><br>            <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>;i&lt;<span class="hljs-number">3</span>;i++)<span class="hljs-keyword">begin</span><br>                <span class="hljs-keyword">if</span>(rs==quene[i])<span class="hljs-keyword">begin</span><br>                    suspend=<span class="hljs-number">2&#x27;b11</span>;<br>                    <span class="hljs-keyword">repeat</span>(<span class="hljs-number">3</span>-i)<span class="hljs-keyword">begin</span><br>                        #<span class="hljs-number">20</span>;<br>                    <span class="hljs-keyword">end</span><br>                    suspend=<span class="hljs-number">0</span>;<br>                    flag = <span class="hljs-number">1</span>;<br>                <span class="hljs-keyword">end</span><br>            <span class="hljs-keyword">end</span><br>            <span class="hljs-keyword">if</span>(!flag)<span class="hljs-keyword">begin</span><br>                quene[<span class="hljs-number">2</span>] = quene[<span class="hljs-number">1</span>];<br>                quene[<span class="hljs-number">1</span>] = quene[<span class="hljs-number">0</span>];<br>                quene[<span class="hljs-number">0</span>] = <span class="hljs-number">5&#x27;bz</span>;<br>            <span class="hljs-keyword">end</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">begin</span><br>                quene[<span class="hljs-number">0</span>] = <span class="hljs-number">5&#x27;bz</span>;<br>                quene[<span class="hljs-number">1</span>] = <span class="hljs-number">5&#x27;bz</span>;<br>                quene[<span class="hljs-number">2</span>] = <span class="hljs-number">5&#x27;bz</span>;<br>                flag = <span class="hljs-number">0</span>;<br>            <span class="hljs-keyword">end</span><br>        <span class="hljs-keyword">end</span>  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(OP_code==<span class="hljs-meta">`J)begin</span><br>            quene[<span class="hljs-number">0</span>] &lt;=<span class="hljs-number">3&#x27;bz</span>;<br>            quene[<span class="hljs-number">1</span>] &lt;= <span class="hljs-number">3&#x27;bz</span>;<br>            quene[<span class="hljs-number">2</span>] &lt;= <span class="hljs-number">3&#x27;bz</span>;<br>            #<span class="hljs-number">11</span> suspend = <span class="hljs-number">2&#x27;b11</span>;<br>            #<span class="hljs-number">58</span> suspend &lt;= <span class="hljs-number">2&#x27;b01</span>;<br>            #<span class="hljs-number">2</span> suspend&lt;=<span class="hljs-number">2&#x27;b00</span>;<br><br>        <span class="hljs-keyword">end</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(OP_code==<span class="hljs-meta">`BEQ) begin</span><br>            <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>;i&lt;<span class="hljs-number">3</span>;i++)<span class="hljs-keyword">begin</span><br>                <span class="hljs-keyword">if</span>(rs==quene[i]||rt==quene[i])<span class="hljs-keyword">begin</span><br>                    suspend=<span class="hljs-number">2&#x27;b11</span>;<br>                    <span class="hljs-keyword">repeat</span>(<span class="hljs-number">3</span>-i)<span class="hljs-keyword">begin</span><br>                        #<span class="hljs-number">20</span>;<br>                    <span class="hljs-keyword">end</span><br>                    suspend = <span class="hljs-number">2&#x27;b0</span>;<br>                    flag = <span class="hljs-number">1</span>;<br>                <span class="hljs-keyword">end</span><br>            <span class="hljs-keyword">end</span><br>            quene[<span class="hljs-number">0</span>] &lt;=<span class="hljs-number">3&#x27;bz</span>;<br>            quene[<span class="hljs-number">1</span>] &lt;= <span class="hljs-number">3&#x27;bz</span>;<br>            quene[<span class="hljs-number">2</span>] &lt;= <span class="hljs-number">3&#x27;bz</span>;<br>            #<span class="hljs-number">11</span> suspend = <span class="hljs-number">2&#x27;b11</span>;<br>            #<span class="hljs-number">58</span> suspend &lt;= <span class="hljs-number">2&#x27;b01</span>;<br>            #<span class="hljs-number">2</span> suspend&lt;=<span class="hljs-number">2&#x27;b00</span>;<br>        <span class="hljs-keyword">end</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">begin</span><br>            quene[<span class="hljs-number">2</span>] = quene[<span class="hljs-number">1</span>];<br>            quene[<span class="hljs-number">1</span>] = quene[<span class="hljs-number">0</span>];<br>            quene[<span class="hljs-number">0</span>] = <span class="hljs-number">5&#x27;bz</span>;<br>        <span class="hljs-keyword">end</span><br><br>    <span class="hljs-keyword">end</span><br><br><span class="hljs-keyword">endmodule</span> <span class="hljs-comment">// HarzardDectection</span><br></code></pre></td></tr></table></figure>

<h4 id="7-寄存器组模块"><a href="#7-寄存器组模块" class="headerlink" title="7. 寄存器组模块"></a>7. 寄存器组模块</h4><blockquote>
<p>寄存器组（RF）是 cpu 中的主要存储模块，工作在 ID 和 WB 周期。<br>在 ID 周期中，寄存器组取出以指令中操作数为地址的值，并输入下一层。<br>在 WB 周期中，RF 接受回送地址和回送数据，实现将结果存入目标地址。<br><strong>verilog 代码实现</strong></p>
</blockquote>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs verilog"><span class="hljs-comment">//REG_F</span><br><span class="hljs-keyword">module</span> Register_File(<br>    <span class="hljs-keyword">input</span> clk,<br>    <span class="hljs-keyword">input</span> reg_wr,<br>    <span class="hljs-keyword">input</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]wr_data,<br>    <span class="hljs-keyword">input</span> [<span class="hljs-number">4</span>:<span class="hljs-number">0</span>]wr_addr,<br>    <span class="hljs-keyword">input</span> [<span class="hljs-number">4</span>:<span class="hljs-number">0</span>]rs_addr,<span class="hljs-comment">//IR[25:20]</span><br>    <span class="hljs-keyword">input</span> [<span class="hljs-number">4</span>:<span class="hljs-number">0</span>]rt_addr,<span class="hljs-comment">//IR[20:16]</span><br>    <span class="hljs-keyword">output</span> <span class="hljs-keyword">reg</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]Rs_data,<br>    <span class="hljs-keyword">output</span> <span class="hljs-keyword">reg</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]Rt_data<br>);<br>    <span class="hljs-keyword">reg</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]data[<span class="hljs-number">31</span>:<span class="hljs-number">0</span>];<br>    <span class="hljs-keyword">initial</span> <span class="hljs-keyword">begin</span><br>        <span class="hljs-built_in">$readmemh</span>(<span class="hljs-string">&quot;txt/RF.txt&quot;</span>, data);<span class="hljs-comment">//通过文件直接初始化</span><br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-comment">// initial begin</span><br>    <span class="hljs-comment">//     for(i = 0;i&lt; 32;i++)begin</span><br>    <span class="hljs-comment">//         data[i] = i;</span><br>    <span class="hljs-comment">//     end</span><br>    <span class="hljs-comment">// end</span><br>    <span class="hljs-keyword">always</span>@(<span class="hljs-keyword">negedge</span> clk)<span class="hljs-keyword">begin</span><br>        <span class="hljs-keyword">if</span>(reg_wr)<span class="hljs-keyword">begin</span><br>            data[wr_addr]&lt;=wr_data;<br>        <span class="hljs-keyword">end</span><br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">begin</span><br>            Rs_data &lt;= data[rs_addr];<br>            Rt_data &lt;= data[rt_addr];<br>        <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">endmodule</span><br></code></pre></td></tr></table></figure>

<h4 id="8-其他逻辑模块"><a href="#8-其他逻辑模块" class="headerlink" title="8. 其他逻辑模块"></a>8. 其他逻辑模块</h4><blockquote>
<p>其他逻辑模块主要包含加法器，16/32 位扩展模块，移位模块，多路选择模块。<br>加法器主要用于 PC 自增和分担运算器功能；<br>16/32 扩展模块用于处理指令中的立即数；<br>移位模块用于处理 beq 跳转指令，工作在 EX 周期；<br>多路选择器是标志位的主要作用对象，工作于 FI, MA, WB 模块。<br><strong>verilog 代码实现</strong></p>
</blockquote>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs verilog"><span class="hljs-comment">//加法器</span><br><span class="hljs-keyword">module</span> Add(<br>    <span class="hljs-keyword">input</span> clk,<br>    <span class="hljs-keyword">input</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]a,<br>    <span class="hljs-keyword">input</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]b,<br>    <span class="hljs-keyword">output</span> <span class="hljs-keyword">reg</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]c<br>    );<br>    <span class="hljs-keyword">always</span> @(<span class="hljs-keyword">negedge</span> clk) <span class="hljs-keyword">begin</span><br>        c = a+b;<br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">endmodule</span><br><br><span class="hljs-keyword">module</span> ShiftUnit(<br>    <span class="hljs-keyword">input</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]a,<br>    <span class="hljs-keyword">output</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]b<br>);<br>    <span class="hljs-keyword">assign</span> b = a&lt;&lt;<span class="hljs-number">2</span>;<br><span class="hljs-keyword">endmodule</span><br><br><span class="hljs-keyword">module</span> SignalExtension(<br>    <span class="hljs-keyword">input</span> [<span class="hljs-number">15</span>:<span class="hljs-number">0</span>]IR16,<br>    <span class="hljs-keyword">output</span> <span class="hljs-keyword">reg</span>[<span class="hljs-number">31</span>:<span class="hljs-number">0</span>] Imm32<br>    );<br>    <span class="hljs-keyword">always</span>@(*)<span class="hljs-keyword">begin</span><br>        Imm32 = &#123;<span class="hljs-number">16&#x27;b0</span>,IR16&#125;;<br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">endmodule</span><br><span class="hljs-keyword">module</span> MUX_2(<br>    <span class="hljs-keyword">input</span> [N-<span class="hljs-number">1</span>:<span class="hljs-number">0</span>]in1,<br>    <span class="hljs-keyword">input</span> [N-<span class="hljs-number">1</span>:<span class="hljs-number">0</span>]in2,<br>    <span class="hljs-keyword">input</span> control,<br>    <span class="hljs-keyword">output</span> <span class="hljs-keyword">reg</span> [N-<span class="hljs-number">1</span>:<span class="hljs-number">0</span>] out<br>);<br>    <span class="hljs-keyword">parameter</span> N = <span class="hljs-number">1</span>;<span class="hljs-comment">//决定二路选择器的数据位数，由外部指定</span><br>    <span class="hljs-keyword">always</span> @(*) <span class="hljs-keyword">begin</span><br>        <span class="hljs-keyword">case</span>(control)<br>            <span class="hljs-number">0</span>:out = in1;<br>            <span class="hljs-number">1</span>:out = in2;<br>        <span class="hljs-keyword">endcase</span><br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">endmodule</span> <span class="hljs-comment">// MUX_2</span><br><br><span class="hljs-comment">//四路选择器</span><br><span class="hljs-keyword">module</span> MUX_4(<br>    <span class="hljs-keyword">input</span> j1,<br>    <span class="hljs-keyword">input</span> j2,<br>    <span class="hljs-keyword">input</span> in1,<br>    <span class="hljs-keyword">input</span> in4,<br>    <span class="hljs-keyword">input</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]npc3,<br>    <span class="hljs-keyword">input</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]npc2,<br>    <span class="hljs-keyword">output</span> <span class="hljs-keyword">reg</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]out<br>    );<br>    <span class="hljs-keyword">always</span> @(*) <span class="hljs-keyword">begin</span><br>        <span class="hljs-keyword">if</span>(j1&amp;&amp;(~j2))out&lt;=npc2;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(j2&amp;&amp;(~j1))out&lt;=npc3;<br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">endmodule</span><br><br></code></pre></td></tr></table></figure>

<h4 id="9-cpu-顶层模块"><a href="#9-cpu-顶层模块" class="headerlink" title="9.cpu 顶层模块"></a>9.cpu 顶层模块</h4><blockquote>
<p>顶层模块中实例化各模块，计算 PC_src, 产生时钟信号，并初始化 PC，使得 cpu 从第一条指令开始运行。<br><strong>verilog 代码实现</strong></p>
</blockquote>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br></pre></td><td class="code"><pre><code class="hljs verilog"><span class="hljs-meta">`<span class="hljs-meta-keyword">define</span> LW 6&#x27;b100011</span><br><span class="hljs-meta">`<span class="hljs-meta-keyword">define</span> SW 6&#x27;b101011</span><br><span class="hljs-meta">`<span class="hljs-meta-keyword">define</span> ADD 6&#x27;b100000</span><br><span class="hljs-meta">`<span class="hljs-meta-keyword">define</span> SUB 6&#x27;b100010</span><br><span class="hljs-meta">`<span class="hljs-meta-keyword">define</span> ADDU 6&#x27;b100001</span><br><span class="hljs-meta">`<span class="hljs-meta-keyword">define</span> AND 6&#x27;b100100</span><br><span class="hljs-meta">`<span class="hljs-meta-keyword">define</span> OR 6&#x27;b100101</span><br><span class="hljs-meta">`<span class="hljs-meta-keyword">define</span> SLT 6&#x27;b101010</span><br><span class="hljs-meta">`<span class="hljs-meta-keyword">define</span> BEQ 6&#x27;b000100</span><br><span class="hljs-meta">`<span class="hljs-meta-keyword">define</span> J 6&#x27;b000010</span><br><span class="hljs-meta">`<span class="hljs-meta-keyword">define</span> HALT 6&#x27;b111111</span><br><br><span class="hljs-meta">`<span class="hljs-meta-keyword">include</span> &quot;mux.v&quot;</span><br><span class="hljs-meta">`<span class="hljs-meta-keyword">include</span> &quot;ControlUnit.v&quot;</span><br><span class="hljs-meta">`<span class="hljs-meta-keyword">include</span> &quot;AluControl.v&quot;</span><br><span class="hljs-meta">`<span class="hljs-meta-keyword">include</span> &quot;ALU.v&quot;</span><br><span class="hljs-meta">`<span class="hljs-meta-keyword">include</span> &quot;Register.v&quot;</span><br><span class="hljs-meta">`<span class="hljs-meta-keyword">include</span> &quot;SigExt.v&quot;</span><br><span class="hljs-meta">`<span class="hljs-meta-keyword">include</span> &quot;PC.v&quot;</span><br><span class="hljs-meta">`<span class="hljs-meta-keyword">include</span> &quot;Add.v&quot;</span><br><span class="hljs-meta">`<span class="hljs-meta-keyword">include</span> &quot;Memory.v&quot;</span><br><span class="hljs-meta">`<span class="hljs-meta-keyword">include</span> &quot;SHL.v&quot;</span><br><span class="hljs-meta">`<span class="hljs-meta-keyword">include</span> &quot;HazardDetection.v&quot;</span><br><br><span class="hljs-keyword">module</span> cpu();<br>    <span class="hljs-comment">//信号位_MA,WB,EX,ID，或级间寄存器内容_MA,WB,EX,ID表示级间寄存器在相应周期内的对应值的输出</span><br>    <span class="hljs-keyword">reg</span> PC_src;<br>    <span class="hljs-keyword">wire</span> ALU_ZF;<br>    <span class="hljs-keyword">wire</span> Jump,flag,Branch,RegDst;<br>    <span class="hljs-keyword">wire</span> Reg_wr,ALU_src,MemtoReg,Mem_wr,Mem_rd;<br>    <span class="hljs-keyword">wire</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]mux_rf_data;<br>    <span class="hljs-keyword">wire</span> [<span class="hljs-number">4</span>:<span class="hljs-number">0</span>]mux_rf_addr;<br>    <span class="hljs-keyword">wire</span> reg_wr_EX,reg_wr_MA,reg_wr_WB;<br>    <span class="hljs-keyword">wire</span> Jump_MA,Jump_EX,Jump_ID;<br>    <span class="hljs-keyword">wire</span> Branch_ID,Branch_EX,Branch_MA;<br>    <span class="hljs-keyword">wire</span> ALU_src_ID,ALU_src_EX,Reg_wr_ID;<br>    <span class="hljs-keyword">wire</span> Mem_rd_EX,Mem_rd_ID,Mem_rd_MA,Mem_wr_ID,Mem_wr_EX,Mem_wr_MA;<br>    <span class="hljs-keyword">wire</span> MemtoReg_ID,MemtoReg_EX,MemtoReg_MA,MemtoReg_WB,RegDst_ID,RegDst_EX,RegDst_MA,RegDst_WB;<br>    <span class="hljs-keyword">wire</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]Rs_EX,Rt_EX,Rt_MA;<br>    <span class="hljs-keyword">wire</span> [<span class="hljs-number">1</span>:<span class="hljs-number">0</span>]suspend;<br>    <span class="hljs-keyword">wire</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]Rs,Rt;<span class="hljs-comment">//直接从RF中输出</span><br>    <span class="hljs-keyword">wire</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]Instr,Imm32;<br>    <span class="hljs-keyword">wire</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]IR_ID,IR_EX,IR_MA,IR_WB;<br>    <span class="hljs-keyword">wire</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]NPC1_FI,NPC1_EX,NPC1_ID;<br>    <span class="hljs-keyword">wire</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]NPC3;<br>    <span class="hljs-keyword">wire</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]NPC2;<br>    <span class="hljs-keyword">wire</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]a_out,b_out;<span class="hljs-comment">//移位输出</span><br>    <span class="hljs-keyword">wire</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]SigExt_out;<br>    <span class="hljs-keyword">wire</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]mux_IF_out;<br>    <span class="hljs-keyword">wire</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]mux4_out,mux_EX_out;<br>    <span class="hljs-keyword">wire</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]ALUOut_EX,ALUOut_MA,ALUOut_WB;<br>    <span class="hljs-keyword">wire</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]PC_out;<br>    <span class="hljs-keyword">wire</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]MEMOut_MA,MEMOut_WB;<br>    <span class="hljs-keyword">wire</span> [<span class="hljs-number">2</span>:<span class="hljs-number">0</span>]ALUOp;<span class="hljs-comment">//由alu控制器产生的用于控制alu运算的信号</span><br>    <span class="hljs-keyword">wire</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>]Add1_out,Add2_out;<br>    <span class="hljs-keyword">reg</span> clk;<br><br>    <span class="hljs-comment">//FI</span><br>    ProgramCounter PC(clk,mux_IF_out,suspend[<span class="hljs-number">1</span>],PC_out);<br>    Add Add1(<span class="hljs-variable">.a</span>(<span class="hljs-number">32&#x27;h4</span>),<span class="hljs-variable">.b</span>(PC_out),<span class="hljs-variable">.c</span>(Add1_out),<span class="hljs-variable">.clk</span>(clk));<br>    MUX_2 <span class="hljs-variable">#(.N(32)) mux_FI(.control(PC_src),.in1(Add1_out),.in2(mux4_out),.out(mux_IF_out))</span>;<br>    InstructionMemory IM(PC_out,Instr);<br><br>    <span class="hljs-comment">//ID</span><br>    RegFI_ID regFI(<br>        <span class="hljs-variable">.clk</span>(clk),<br>        <span class="hljs-variable">.NPC1in</span>(Add1_out),<br>        <span class="hljs-variable">.suspend</span>(suspend[<span class="hljs-number">0</span>]),<br>        <span class="hljs-variable">.IRin</span>(Instr),<br>        <span class="hljs-variable">.IRout</span>(IR_ID),<br>        <span class="hljs-variable">.NPC1out</span>(NPC1_ID),<br>        <span class="hljs-variable">.reg_wr_in</span>(reg_wr),<br>        <span class="hljs-variable">.ALU_src_in</span>(ALU_src),<br>        <span class="hljs-variable">.Jump_in</span>(Jump),<br>        <span class="hljs-variable">.Branch_in</span>(Branch),<br>        <span class="hljs-variable">.Mem_rd_in</span>(Mem_rd),<br>        <span class="hljs-variable">.Mem_wr_in</span>(Mem_wr),<br>        <span class="hljs-variable">.MemtoReg_in</span>(MemtoReg),<br>        <span class="hljs-variable">.RegDst_in</span>(RegDst),<br>        <span class="hljs-variable">.reg_wr</span>(Reg_wr_ID),<br>        <span class="hljs-variable">.ALU_src</span>(ALU_src_ID),<br>        <span class="hljs-variable">.Jump</span>(Jump_ID),<br>        <span class="hljs-variable">.Branch</span>(Branch_ID),<br>        <span class="hljs-variable">.Mem_rd</span>(Mem_rd_ID),<br>        <span class="hljs-variable">.Mem_wr</span>(Mem_wr_ID),<br>        <span class="hljs-variable">.MemtoReg</span>(MemtoReg_ID),<br>        <span class="hljs-variable">.RegDst</span>(RegDst_ID)<br>    );<br>    SignalExtension sig(IR_ID[<span class="hljs-number">15</span>:<span class="hljs-number">0</span>],SigExt_out);<br>    Register_File RF(<br>        <span class="hljs-variable">.clk</span>(clk),<br>        <span class="hljs-variable">.reg_wr</span>(reg_wr),<br>        <span class="hljs-variable">.wr_addr</span>(mux_rf_addr),<br>        <span class="hljs-variable">.wr_data</span>(mux_rf_data),<br>        <span class="hljs-variable">.rs_addr</span>(IR_ID[<span class="hljs-number">25</span>:<span class="hljs-number">21</span>]),<br>        <span class="hljs-variable">.rt_addr</span>(IR_ID[<span class="hljs-number">20</span>:<span class="hljs-number">16</span>]),<br>        <span class="hljs-variable">.Rs_data</span>(Rs),<br>        <span class="hljs-variable">.Rt_data</span>(Rt)<br>    );<br><br>    <span class="hljs-comment">//EX</span><br>    RegID_EX regIE(clk,NPC1_ID,Rs,Rt,SigExt_out,IR_ID,<br>    Reg_wr_ID,ALU_src_ID,Jump_ID,Branch_ID,Mem_rd_ID,Mem_wr_ID,<br>    MemtoReg_ID,RegDst_ID,NPC1_EX,IR_EX,Rt_EX,Rs_EX,Imm32,reg_wr_EX,<br>    ALU_src_EX,Jump_EX,Branch_EX,Mem_rd_EX,Mem_wr_EX,MemtoReg_EX,RegDst_EX);<br>    ShiftUnit shl2a(&#123;<span class="hljs-number">6&#x27;b0</span>,IR_EX[<span class="hljs-number">25</span>:<span class="hljs-number">0</span>]&#125;,a_out);<br>    ShiftUnit shl2b(Imm32,b_out);<br>    Add Add2(<span class="hljs-variable">.a</span>(NPC1_EX),<span class="hljs-variable">.b</span>(b_out),<span class="hljs-variable">.c</span>(Add2_out),<span class="hljs-variable">.clk</span>(clk));<br>    ALU alu(<span class="hljs-variable">.alu_op</span>(ALUOp),<span class="hljs-variable">.A</span>(Rs_EX),<span class="hljs-variable">.B</span>(mux_EX_out),<span class="hljs-variable">.ALU_out</span>(ALUOut_EX),<span class="hljs-variable">.flag</span>(ALU_ZF));<br>    AluControl AluC(IR_EX[<span class="hljs-number">5</span>:<span class="hljs-number">0</span>],IR_EX[<span class="hljs-number">31</span>:<span class="hljs-number">26</span>],ALUOp);<br>    MUX_2 <span class="hljs-variable">#(.N(32)) mux_EX(.control(ALU_src_EX),.in1(Rt_EX),.in2(Imm32),.out(mux_EX_out))</span>;<br><br>    <span class="hljs-comment">//MA</span><br>    RegEX_MA regEM(<br>        <span class="hljs-variable">.clk</span>(clk),<br>        <span class="hljs-variable">.NPC3_in</span>(&#123;NPC1_EX[<span class="hljs-number">31</span>:<span class="hljs-number">28</span>],a_out[<span class="hljs-number">27</span>:<span class="hljs-number">0</span>]&#125;),<br>        <span class="hljs-variable">.NPC2_in</span>(Add2_out),<br>        <span class="hljs-variable">.NPC3</span>(NPC3),<br>        <span class="hljs-variable">.NPC2</span>(NPC2),<br>        <span class="hljs-variable">.ALUout_in</span>(ALUOut_EX),<br>        <span class="hljs-variable">.ALUout</span>(ALUOut_MA),<br>        <span class="hljs-variable">.Rt_in</span>(Rt_EX),<br>        <span class="hljs-variable">.IR_in</span>(IR_EX),<br>        <span class="hljs-variable">.Rt</span>(Rt_MA),<br>        <span class="hljs-variable">.IR</span>(IR_MA),<br>        <span class="hljs-variable">.flag_in</span>(ALU_ZF),<br>        <span class="hljs-variable">.flag</span>(flag),<br>        <span class="hljs-variable">.reg_wr_in</span>(reg_wr_EX),<br>        <span class="hljs-variable">.reg_wr</span>(reg_wr_MA),<br>        <span class="hljs-variable">.Jump_in</span>(Jump_EX),<br>        <span class="hljs-variable">.Jump</span>(Jump_MA),<br>        <span class="hljs-variable">.Branch_in</span>(Branch_EX),<br>        <span class="hljs-variable">.Branch</span>(Branch_MA),<br>        <span class="hljs-variable">.Mem_rd_in</span>(Mem_rd_EX),<br>        <span class="hljs-variable">.Mem_rd</span>(Mem_rd_MA),<br>        <span class="hljs-variable">.Mem_wr_in</span>(Mem_wr_EX),<br>        <span class="hljs-variable">.Mem_wr</span>(Mem_wr_MA),<br>        <span class="hljs-variable">.MemtoReg_in</span>(MemtoReg_EX),<br>        <span class="hljs-variable">.MemtoReg</span>(MemtoReg_MA),<br>        <span class="hljs-variable">.RegDst_in</span>(RegDst_EX),<br>        <span class="hljs-variable">.RegDst</span>(RegDst_MA)<br>    );<br><br>    MUX_4 m0(<br>        <span class="hljs-variable">.j1</span>(flag&amp;&amp;Branch_MA),<br>        <span class="hljs-variable">.j2</span>(Jump_MA),<br>        <span class="hljs-variable">.in1</span>(<span class="hljs-number">1&#x27;b0</span>),<br>        <span class="hljs-variable">.in4</span>(<span class="hljs-number">1&#x27;b0</span>),<br>        <span class="hljs-variable">.npc3</span>(NPC3),<br>        <span class="hljs-variable">.npc2</span>(NPC2),<br>        <span class="hljs-variable">.out</span>(mux4_out)<br>    );<br><br>    DataMemory DM(Mem_rd_MA,Mem_wr_MA,ALUOut_MA,Rt_MA,MEMOut_MA);<br><br>    <span class="hljs-comment">//WB</span><br>    RegMA_WB regMW(<br>        <span class="hljs-variable">.clk</span>(clk),<br>        <span class="hljs-variable">.ALU</span>(ALUOut_MA),<br>        <span class="hljs-variable">.MEM</span>(MEMOut_MA),<br>        <span class="hljs-variable">.IRin</span>(IR_MA),<br>        <span class="hljs-variable">.ALUout</span>(ALUOut_WB),<br>        <span class="hljs-variable">.MEMout</span>(MEMOut_WB),<br>        <span class="hljs-variable">.IRout</span>(IR_WB),<br>        <span class="hljs-variable">.MemtoReg_in</span>(MemtoReg_MA),<br>        <span class="hljs-variable">.MemtoReg</span>(MemtoReg_WB),<br>        <span class="hljs-variable">.RegDst_in</span>(RegDst_MA),<br>        <span class="hljs-variable">.RegDst</span>(RegDst_WB),<br>        <span class="hljs-variable">.reg_wr_in</span>(reg_wr_MA),<br>        <span class="hljs-variable">.reg_wr</span>(reg_wr_WB)<br>    );<br>    MUX_2 <span class="hljs-variable">#(.N(32)) mux_WB1 (.control(MemtoReg_WB),.in1(ALUOut_WB),.in2(MEMOut_WB),.out(mux_rf_data))</span>;<br>    MUX_2 <span class="hljs-variable">#(.N(5)) mux_WB2(.control(RegDst_WB),.in1(IR_WB[20:16]),.in2(IR_WB[15:11]),.out(mux_rf_addr))</span>;<br>    <span class="hljs-comment">//控啊器和冲突检测</span><br><br>    ControlUnit CU(Instr[<span class="hljs-number">31</span>:<span class="hljs-number">26</span>],reg_wr,ALU_src,Jump,Branch,MemtoReg,RegDst,Mem_rd,Mem_wr);<br>    HazardDetection HD(<br>        <span class="hljs-variable">.clk</span>(clk),<br>        <span class="hljs-variable">.OP_code</span>(Instr[<span class="hljs-number">31</span>:<span class="hljs-number">26</span>]),<br>        <span class="hljs-variable">.rs</span>(Instr[<span class="hljs-number">25</span>:<span class="hljs-number">21</span>]),<br>        <span class="hljs-variable">.rt</span>(Instr[<span class="hljs-number">20</span>:<span class="hljs-number">16</span>]),<br>        <span class="hljs-variable">.rd</span>(Instr[<span class="hljs-number">15</span>:<span class="hljs-number">11</span>]),<br>        <span class="hljs-variable">.suspend</span>(suspend)<br>    );<br>    <span class="hljs-keyword">always</span> @(*) <span class="hljs-keyword">begin</span><br>        PC_src &lt;= (flag&amp;&amp;Branch_MA)||Jump_MA;<span class="hljs-comment">//控制pc的改变</span><br><br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">initial</span> <span class="hljs-keyword">begin</span><br>        PC_src = <span class="hljs-number">0</span>;<br>        clk = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">repeat</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">begin</span><span class="hljs-comment">//产生时钟信号</span><br>            #<span class="hljs-number">10</span><br>            clk = ~clk;<br>        <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-comment">// initial begin</span><br>    <span class="hljs-comment">//     #2000 $finish;</span><br>    <span class="hljs-comment">// end</span><br><span class="hljs-keyword">endmodule</span><br><br></code></pre></td></tr></table></figure>

<h3 id="三、测试方法和工具"><a href="#三、测试方法和工具" class="headerlink" title="三、测试方法和工具"></a>三、测试方法和工具</h3><h4 id="1-汇编器"><a href="#1-汇编器" class="headerlink" title="1. 汇编器"></a>1. 汇编器</h4><blockquote>
<p>汇编器是将汇编语言转换成机器语言指令的工具，通过 python 中 ply 模块的 lex 模块和 yacc 模块可以较为轻松的编写汇编器。</p>
</blockquote>
<blockquote>
<p>需要 python3，pip 环境<br>安装依赖</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">pip3 install ply<br></code></pre></td></tr></table></figure>

<p>代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># coding:utf-8</span><br><span class="hljs-comment"># ---------</span><br><span class="hljs-comment"># 简易mips指令汇编器 词法分析</span><br><span class="hljs-comment"># author：bibibi</span><br><span class="hljs-comment"># ---------</span><br><br><span class="hljs-keyword">import</span> ply.lex <span class="hljs-keyword">as</span> lex<br><br>CODE_dict = &#123;<br>    <span class="hljs-string">&#x27;LW&#x27;</span>: <span class="hljs-string">&#x27;100011&#x27;</span>,<br>    <span class="hljs-string">&#x27;SW&#x27;</span>: <span class="hljs-string">&#x27;101011&#x27;</span>,<br>    <span class="hljs-string">&#x27;ADD&#x27;</span>: <span class="hljs-string">&#x27;000000&#x27;</span>,<br>    <span class="hljs-string">&#x27;SUB&#x27;</span>: <span class="hljs-string">&#x27;000000&#x27;</span>,<br>    <span class="hljs-string">&#x27;OR&#x27;</span>: <span class="hljs-string">&#x27;000000&#x27;</span>,<br>    <span class="hljs-string">&#x27;AND&#x27;</span>: <span class="hljs-string">&#x27;000000&#x27;</span>,<br>    <span class="hljs-string">&#x27;SLT&#x27;</span>: <span class="hljs-string">&#x27;000000&#x27;</span>,<br>    <span class="hljs-string">&#x27;BEQ&#x27;</span>: <span class="hljs-string">&#x27;000100&#x27;</span>,<br>    <span class="hljs-string">&#x27;J&#x27;</span>: <span class="hljs-string">&#x27;000010&#x27;</span><br>&#125;<br><br>CAL_dict = &#123;<br>    <span class="hljs-string">&#x27;ADD&#x27;</span>: <span class="hljs-string">&#x27;100000&#x27;</span>,<br>    <span class="hljs-string">&#x27;SUB&#x27;</span>: <span class="hljs-string">&#x27;100010&#x27;</span>,<br>    <span class="hljs-string">&#x27;OR&#x27;</span>: <span class="hljs-string">&#x27;100101&#x27;</span>,<br>    <span class="hljs-string">&#x27;AND&#x27;</span>: <span class="hljs-string">&#x27;100100&#x27;</span>,<br>    <span class="hljs-string">&#x27;SLT&#x27;</span>: <span class="hljs-string">&#x27;101010&#x27;</span>,<br>&#125;<br><br>tokens = (<br>    <span class="hljs-string">&#x27;OPCODE&#x27;</span>,        <span class="hljs-comment"># 指令码</span><br>    <span class="hljs-string">&#x27;REG&#x27;</span>,           <span class="hljs-comment"># 寄存器</span><br>    <span class="hljs-string">&#x27;IMME&#x27;</span>,          <span class="hljs-comment"># 立即数</span><br>    <span class="hljs-string">&#x27;LPAREN&#x27;</span>,        <span class="hljs-comment"># 左括号</span><br>    <span class="hljs-string">&#x27;RPAREN&#x27;</span>         <span class="hljs-comment"># 右括号</span><br>)<br><br>t_LPAREN = <span class="hljs-string">r&#x27;\(&#x27;</span><br>t_RPAREN = <span class="hljs-string">r&#x27;\)&#x27;</span><br><br><span class="hljs-comment"># 操作码</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">t_OPCODE</span>(<span class="hljs-params">t</span>):</span><br>    <span class="hljs-string">r&#x27;(LW)|(SW)|(ADD)|(SUB)|(OR)|(AND)|(SLT)|(BEQ)|(J)&#x27;</span><br>    <span class="hljs-comment"># 如果是数字逻辑运算型指令,则需要加上对应的操作码</span><br>    <span class="hljs-keyword">if</span> t.value <span class="hljs-keyword">in</span> CAL_dict:<br>        t.value=[CODE_dict[t.value],CAL_dict[t.value]]<br>    <span class="hljs-keyword">else</span>:<br>        t.value = CODE_dict[t.value]<br>    <span class="hljs-keyword">return</span> t<br><br><span class="hljs-comment"># 寄存器</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">t_REG</span>(<span class="hljs-params">t</span>):</span><br>    <span class="hljs-string">r&#x27;\$\d+&#x27;</span><br>    <span class="hljs-comment"># 寄存器号码直接转化为对应的二进制表示</span><br>    t.value = <span class="hljs-string">&quot;%05d&quot;</span>%int(bin(int(t.value[<span class="hljs-number">1</span>:]))[<span class="hljs-number">2</span>:])<br>    <span class="hljs-comment"># t.value = bin(int(t.value[1:]))[2:]</span><br>    <span class="hljs-keyword">return</span> t<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">t_IMME</span>(<span class="hljs-params">t</span>):</span><br>    <span class="hljs-string">r&#x27;\d+&#x27;</span><br>    <span class="hljs-comment"># 由于数字可能是I型指令的16位,也可能是J型指令的26位</span><br>    <span class="hljs-comment"># 保存原数字的值,在语法分析种再进行转换</span><br>    <span class="hljs-comment"># t.value = &quot;%05d&quot;%int(bin(int(t.value))[2:])</span><br>    <span class="hljs-comment"># t.value = bin(int(t.value))[2:]</span><br>    <span class="hljs-comment"># t.value = (t.value[0]==&#x27;-&#x27;)?(-1*int(t.value)):int(t.value);</span><br>    t.value = int(t.value)<br>    <span class="hljs-keyword">return</span> t<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">t_newline</span>(<span class="hljs-params">t</span>):</span><br>    <span class="hljs-string">r&#x27;\n+&#x27;</span><br>    t.lexer.lineno += len(t.value)<br><br>t_ignore = <span class="hljs-string">&#x27;, \t&#x27;</span><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">t_error</span>(<span class="hljs-params">t</span>):</span><br>    print(<span class="hljs-string">&quot;Illegal character &#x27;%s&#x27;&quot;</span> % t.value[<span class="hljs-number">0</span>])<br>    t.lexer.skip(<span class="hljs-number">1</span>)<br><br>lexer = lex.lex()<br><br><span class="hljs-keyword">import</span> ply.yacc <span class="hljs-keyword">as</span> yacc<br><br><span class="hljs-comment"># 存储器访问指令,即I型指令</span><br><span class="hljs-comment"># 将立即数转换为16位二进制数</span><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">p_operation_mem</span>(<span class="hljs-params">p</span>):</span><br>    <span class="hljs-string">&#x27;operation : OPCODE REG IMME LPAREN REG RPAREN&#x27;</span><br>    p[<span class="hljs-number">0</span>] = p[<span class="hljs-number">1</span>] + p[<span class="hljs-number">5</span>] + p[<span class="hljs-number">2</span>] + <span class="hljs-string">&quot;%016d&quot;</span> % int(bin(int(p[<span class="hljs-number">3</span>]))[<span class="hljs-number">2</span>:])<br>    p[<span class="hljs-number">0</span>] = <span class="hljs-string">&quot;%08x&quot;</span>%(int(p[<span class="hljs-number">0</span>],base=<span class="hljs-number">2</span>)) + <span class="hljs-string">&#x27;\n&#x27;</span><br><br><span class="hljs-comment"># 算术逻辑运算,即R型指令</span><br><span class="hljs-comment"># 需要根据在指令的最后加上操作码</span><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">p_operation_cal</span>(<span class="hljs-params">p</span>):</span><br>    <span class="hljs-string">&#x27;operation : OPCODE REG REG REG&#x27;</span><br>    p[<span class="hljs-number">0</span>] = p[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>] + p[<span class="hljs-number">3</span>] + p[<span class="hljs-number">4</span>] + p[<span class="hljs-number">2</span>] + <span class="hljs-string">&#x27;00000&#x27;</span> + p[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>]<br>    p[<span class="hljs-number">0</span>] = <span class="hljs-string">&quot;%08x&quot;</span>%(int(p[<span class="hljs-number">0</span>],base=<span class="hljs-number">2</span>)) + <span class="hljs-string">&#x27;\n&#x27;</span><br><br><span class="hljs-comment"># BEQ指令,I型指令</span><br><span class="hljs-comment"># 将立即数转换为16位二进制数</span><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">p_operation_beq</span>(<span class="hljs-params">p</span>):</span><br>    <span class="hljs-string">&#x27;operation : OPCODE REG REG IMME&#x27;</span><br>    p[<span class="hljs-number">0</span>] = p[<span class="hljs-number">1</span>] + p[<span class="hljs-number">2</span>] + p[<span class="hljs-number">3</span>] + <span class="hljs-string">&quot;%016d&quot;</span> % int(bin(int(p[<span class="hljs-number">4</span>]))[<span class="hljs-number">2</span>:])<br>    p[<span class="hljs-number">0</span>] = <span class="hljs-string">&quot;%08x&quot;</span>%(int(p[<span class="hljs-number">0</span>],base=<span class="hljs-number">2</span>)) + <span class="hljs-string">&#x27;\n&#x27;</span><br><br><span class="hljs-comment"># J指令,J型指令</span><br><span class="hljs-comment"># 将立即数转换为26位二进制数</span><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">p_operation_j</span>(<span class="hljs-params">p</span>):</span><br>    <span class="hljs-string">&#x27;operation : OPCODE IMME&#x27;</span><br>    p[<span class="hljs-number">0</span>] = p[<span class="hljs-number">1</span>] + <span class="hljs-string">&quot;%026d&quot;</span> % int(bin(int(p[<span class="hljs-number">2</span>]))[<span class="hljs-number">2</span>:])<br>    p[<span class="hljs-number">0</span>] = <span class="hljs-string">&quot;%08x&quot;</span>%(int(p[<span class="hljs-number">0</span>],base=<span class="hljs-number">2</span>)) + <span class="hljs-string">&#x27;\n&#x27;</span><br><br><span class="hljs-comment"># 若干条指令合并成一段连续的代码</span><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">p_program</span>(<span class="hljs-params">p</span>):</span><br>    <span class="hljs-string">&#x27;operation : operation operation&#x27;</span><br>    p[<span class="hljs-number">0</span>] = p[<span class="hljs-number">1</span>] + p[<span class="hljs-number">2</span>]<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">p_error</span>(<span class="hljs-params">p</span>):</span><br>    print(<span class="hljs-string">&quot;Syntax error in input!&quot;</span>)<br><br>parser = yacc.yacc()<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">compile</span>(<span class="hljs-params">data</span>):</span><br>    result = parser.parse(data)<br>    <span class="hljs-keyword">return</span> result<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    <span class="hljs-keyword">with</span> open(<span class="hljs-string">&quot;./txt/data.txt&quot;</span>,<span class="hljs-string">&#x27;r&#x27;</span>) <span class="hljs-keyword">as</span> file:<br>        data = file.read()<br><br>    result = compile(data)<br><br>    <span class="hljs-keyword">with</span> open(<span class="hljs-string">&quot;./data.out&quot;</span>,<span class="hljs-string">&#x27;w&#x27;</span>) <span class="hljs-keyword">as</span> file:<br>        file.write(result)<br><br>    print(result)<br></code></pre></td></tr></table></figure>

<h4 id="2-存储器初始化"><a href="#2-存储器初始化" class="headerlink" title="2. 存储器初始化"></a>2. 存储器初始化</h4><blockquote>
<p>指令存储器和寄存器组可以通过 verilog 自带函数读取.txt 文件初始化。<br>数据存储器在代码中自行初始化。<br>PC 初始化为 0.<br>RF 初始化如下：<br>11111111<br>22222222<br>33333333<br>44444444<br>55555555<br>66666666<br>77777777<br>88888888<br>99999999<br>aaaaaaaa<br>bbbbbbbb<br>cccccccc<br>dddddddd<br>eeeeeeee<br>ffffffff<br>12345678<br>87654321<br>01234567<br>76543210<br>00000000<br>00000000<br>00000000<br>00000000<br>00000000<br>00000000<br>00000000<br>00000000<br>00000000<br>00000000<br>00000000<br>00000000<br>00000000</p>
</blockquote>
<h3 id="四、测试结果"><a href="#四、测试结果" class="headerlink" title="四、测试结果"></a>四、测试结果</h3><h4 id="1-测试指令"><a href="#1-测试指令" class="headerlink" title="1. 测试指令"></a>1. 测试指令</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs plain">ADD $1,$2,$3<br>J 4<br>SUB $2,$3,$4<br>AND $1,$2,$3<br>SLT $1,$2,$3<br>LW $1,10($2)<br>BEQ $1,$2,2<br>SW $1,10($2)<br>ADDU $1,$2,$3<br>HLT<br></code></pre></td></tr></table></figure>

<blockquote>
<p>转换为十六进制机器指令</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs plain">00 43 08 20<br>08 00 00 04<br>00 64 10 22<br>00 43 08 24<br>00 43 08 2a<br>8c 41 00 0a<br>10 22 00 02<br>ac 41 00 0a<br>00 43 08 20<br>fc 00 00 00<br></code></pre></td></tr></table></figure>

<h4 id="2-vivado-模拟"><a href="#2-vivado-模拟" class="headerlink" title="2.vivado 模拟"></a>2.vivado 模拟</h4><img src="https://blogpics.lenmain.cn/static/images/2019-12-28-20-53-58.png">

<h4 id="3-测试模块"><a href="#3-测试模块" class="headerlink" title="3. 测试模块"></a>3. 测试模块</h4><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs verilog"><span class="hljs-keyword">module</span> test();<br>    cpu cpu1();<br>    <span class="hljs-keyword">initial</span> <span class="hljs-keyword">begin</span><br>        <span class="hljs-built_in">$dumpfile</span>(<span class="hljs-string">&quot;cpu.vcd&quot;</span>);<br>        <span class="hljs-built_in">$dumpvars</span>(<span class="hljs-number">0</span>,cpu1);<br>        #<span class="hljs-number">1000</span>;<br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">endmodule</span> <span class="hljs-comment">// test</span><br><br></code></pre></td></tr></table></figure>

<h4 id="4-波形效果"><a href="#4-波形效果" class="headerlink" title="4. 波形效果"></a>4. 波形效果</h4><img src="https://blogpics.lenmain.cn/static/images/2019-12-28-20-56-25.png">
<img src="https://blogpics.lenmain.cn/static/images/2019-12-28-20-55-51.png">
<img src="https://blogpics.lenmain.cn/static/images/2019-12-28-20-56-40.png">
<img src="https://blogpics.lenmain.cn/static/images/2019-12-28-20-56-58.png">
<img src="https://blogpics.lenmain.cn/static/images/2019-12-28-20-57-16.png">
<img src="https://blogpics.lenmain.cn/static/images/2019-12-28-20-57-28.png">
<img src="https://blogpics.lenmain.cn/static/images/2019-12-28-20-57-45.png">
<img src="https://blogpics.lenmain.cn/static/images/2019-12-28-20-58-04.png">

<h3 id="五、改进方案"><a href="#五、改进方案" class="headerlink" title="五、改进方案"></a>五、改进方案</h3><p>本次实验中为了解决数据冲突和控制冲突，主要采用了插入气泡的后退法，但是尽管后退法的结构简单，不会引入较为复杂的连线和结构，但浪费了较多的 cpu 周期，削弱了<br>流水线 cpu 相较于其他 cpu 效率更高的优点。为了保证指令执行的效率，可以使用专用的数据通路提前回送数据从而取代气泡的插入。同时，对于控制冒险，可以将 J 指令在 FI<br>周期内完成，BEQ 指令在 FI 和 ID 周期内完成，可以实现 J 指令不插入气泡，BEQ 指令只插入一个气泡，但要实现这一结构，本次实验会对级间寄存器结构有较大的改动，因此没有实现。</p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">lenmain</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://vercel-hexo-ten.vercel.app/2020/02/15/%E7%AE%80%E6%98%93%E4%BA%94%E6%B5%81%E6%B0%B4%E7%BA%BFcpu%E5%AE%9E%E7%8E%B0/">https://vercel-hexo-ten.vercel.app/2020/02/15/%E7%AE%80%E6%98%93%E4%BA%94%E6%B5%81%E6%B0%B4%E7%BA%BFcpu%E5%AE%9E%E7%8E%B0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-full"><a href="/2020/03/02/GO%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><img class="prev-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">GO语言学习笔记</div></div></a></div></nav></article></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By lenmain</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><section id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></section><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></div></body></html>